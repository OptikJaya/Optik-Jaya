<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optik Jaya</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel=“stylesheet” type=“text/css” href=“styles.css”>
</head>
<body>
     <!-- Login Form -->
     <div id="login-container" class="form-container">
        <h2>Login to Optik Jaya</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Nama Pengguna:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Kata sandi:</label>
                <input type="password" id="password" required>
                <input type="checkbox" id="togglePassword"> Lihat Sandi
            </div>
            
            <input type="submit" value="Login">
        </form>
    </div>
    
    <div id="menu-container" class="form-container" style="display: none;">
        <h2>Menu</h2>
        <button id="fill-form-btn" class="menu-btn">Isi Formulir</button>
        <button id="show-data-btn" class="menu-btn">Tampilkan Data Google Sheet</button>
    </div>

    <div id="form-container" class="form-container" style="display: none;">
        <button id="back-to-menu-btn" class="back-btn">Kembali</button>
        <!-- User Info Section in the Top Right -->
        <div id="user-info-container" style="position: absolute; top: 20px; right: 20px;">
            <button id="user-info-btn" style="background-color: #2E7445; color: white; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer;">
                <!-- Username will be inserted here dynamically -->
            </button>
            <div id="user-dropdown" style="display: none; background-color: white; border: 1px solid #ccc; padding: 10px; position: absolute; top: 40px; right: 0px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);">
                <button id="logout-btn" style="background-color: #d9534f; color: white; border: none; border-radius: 8px; padding: 8px 15px; cursor: pointer;">Logout</button>
            </div>
        </div>
        
    
        <!-- Logo -->
        <img src="https://i.imgur.com/ciEloG8.png" alt="Logo" class="logo">  <!-- Add your logo URL here -->
        <h2>Data Pasien Optik Jaya</h2>

        <form id="form" action="https://script.google.com/macros/s/AKfycbz5bTQoETiNwyYpyueNcFWmmSGATbHmXoXO_16YQ4265MzW55NkFM7RmfJkcnJgqk1j/exec" method="POST" onsubmit="submitForm(event)">

            <!-- Collapsible Section 1 - Data Diri Pelanggan -->
            <button type="button" class="collapsible">Data Diri Pelanggan</button>
            <div class="content">
                <div class="form-group">
                    <label for="name">Nama:</label>
                    <input type="text" id="name" name="Nama" required>
                </div>

                <div class="form-group">
                    <label for="address">Alamat:</label>
                    <input type="text" id="address" name="Alamat" required>
                </div>

                <div class="form-group">
                    <label for="age">Umur:</label>
                    <input type="text" id="age" name="Umur" required>
                </div>

                <div class="form-group">
                    <label for="phone">HP:</label>
                    <input type="tel" id="phone" name="HP" pattern="[0-9]{12,13}" placeholder="1234567890" required>
                </div>

                <div class="field">
                    <label class="label">Status Pelanggan</label>
                    <div class="control">
                      <label class="radio">
                        <input type="radio" name="Status Pelanggan" value="Umum" /> Umum
                      </label>
                      <label class="radio">
                        <input type="radio" name="Status Pelanggan" value="BPJS" /> BPJS
                      </label>
                    </div>
                  </div>

                <div class="form-group">
                    <label for="coordinates">Koordinat Maps:</label>
                    <input type="text" id="coordinates" name="Koordinat" placeholder="e.g. -6.200000, 106.816666" required>
                </div>
            </div>

            <!-- Collapsible Section 2 - Detail Pemesanan -->
            <button type="button" class="collapsible">Detail Pemesanan</button>
            <div class="content">
                <!-- Lensa field with multiple checkboxes -->
                <div class="form-group">
                    <label for="lensa">Lensa:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="lensa" value="Single - CRMC"> Single - WhiteMC</label>
                        <label><input type="checkbox" name="lensa" value="Single - CRMC"> Single - CRMC</label>
                        <label><input type="checkbox" name="lensa" value="Single - Photochromic"> Single - Photochromic</label>
                        <label><input type="checkbox" name="lensa" value="Single - Bluechromic"> Single - Bluechromic</label>
                        <label><input type="checkbox" name="lensa" value="Single - Night Drive"> Single - Night Drive</label>
                        <label><input type="checkbox" name="lensa" value="Single - Blu-ray"> Single - Blu-ray</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - CRMC"> Kriptok - WhiteMC</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - CRMC"> Kriptok - CRMC</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - Photochromic"> Kriptok - Photochromic</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - Bluechromic"> Kriptok - Bluechromic</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - CRMC"> Progressive - CRMC</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Photochromic"> Progressive - Photochromic</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Bluechromic"> Progressive - Bluechromic</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Night Drive"> Progressive - Night Drive</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Blu-ray"> Progressive - Blu-ray</label>
                    </div>
                </div>

                <!-- Frame field -->
                <div class="form-group">
                    <label for="frame">Frame:</label>
                    <input type="text" id="frame" name="frame" required>
                </div>

                <!-- Harga Awal -->
                <div class="form-group">
                    <label for="harga-awal">Harga Awal:</label>
                    <input type="number" id="harga-awal" name="harga awal" required>
                </div>

                <!-- Harga TT/Potongan -->
                <div class="form-group">
                    <label for="harga-tt">Harga TT/Potongan:</label>
                    <input type="number" id="harga-tt" name="harga-tt" required>
                </div>

                <!-- Harga Akhir -->
                <div class="form-group">
                    <label for="harga-akhir">Harga Akhir:</label>
                    <input type="number" id="harga-akhir" name="harga-akhir" required>
                </div>
            </div>

            <!-- Collapsible Section 3 - Status Refraksi -->
            <button type="button" class="collapsible">Status Refraksi</button>
            <div class="content">
                <div class="form-group">
                    <label>Status Refraksi:</label>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>SPH</th>
                                <th>CYL</th>
                                <th>AXIS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Kanan</td>
                                <td><input type="text" name="sph-kanan" placeholder="SPH Kanan"></td>
                                <td><input type="text" name="cyl-kanan" placeholder="CYL Kanan"></td>
                                <td><input type="text" name="axis-kanan" placeholder="AXIS Kanan"></td>
                                
                            </tr>
                            <tr>
                                <td>Kiri</td>
                                <td><input type="text" name="sph-kiri" placeholder="SPH Kiri"></td>
                                <td><input type="text" name="cyl-kiri" placeholder="CYL Kiri"></td>
                                <td><input type="text" name="axis-kiri" placeholder="AXIS Kiri"></td>
                                
                            </tr>
                            <tr>
                                <td>ADD</td>
                                <td><input type="text" name="sph-add" placeholder="SPH ADD"></td>
                                <td><input type="text" name="cyl-add" placeholder="CYL ADD"></td>
                                <td><input type="text" name="axis-add" placeholder="AXIS ADD"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Collapsible Section 4 - Kirim & Tagih -->
            <button type="button" class="collapsible">Kirim & Tagih</button>
            <div class="content">
                <!-- DP field -->
                <div class="form-group">
                    <label for="dp">DP (IDR):</label>
                    <input type="number" id="dp" name="DP" required placeholder="Masukkan DP" step="any">
                </div>

                <!-- Tanggal Penagihan fields -->
                <div class="form-group">
                    <div class="penagihan-dates">
                        <label for="tanggal-1">Penagihan 1:</label>
                        <input type="date" id="tanggal-1" name="tanggal-1" required>

                        <label for="tanggal-2">Penagihan 2:</label>
                        <input type="date" id="tanggal-2" name="tanggal-2" >

                        <label for="tanggal-3">Penagihan 3:</label>
                        <input type="date" id="tanggal-3" name="tanggal-3" >

                        <label for="tanggal-4">Penagihan 4:</label>
                        <input type="date" id="tanggal-4" name="tanggal-4" >

                        <label for="tanggal-5">Penagihan 5:</label>
                        <input type="date" id="tanggal-5" name="tanggal-5" >

                        <label for="tanggal-6">Penagihan 6:</label>
                        <input type="date" id="tanggal-6" name="tanggal-6" >

                        <label for="tanggal-7">Penagihan 7:</label>
                        <input type="date" id="tanggal-7" name="tanggal-7" >
                    </div>
                </div>
            </div>
            
            <!-- Add the hidden input field here to store the username -->
            <input type="hidden" id="username-field" name="username" value="">

            <!-- Submit Button -->
            <input type="submit" value="Kirim Data" id="submit-button">
        </form>
    </div>

    <script>
            
         // Get references to the user info elements
        const userInfoBtn = document.getElementById('user-info-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const logoutBtn = document.getElementById('logout-btn');

       // Function to run when the window loads
        window.onload = function () {
            // Check if the user is logged in
            if (localStorage.getItem('loggedIn') === 'true') {
                const username = localStorage.getItem('username'); // Retrieve the username
                const userInfoBtn = document.getElementById('user-info-btn'); // Reference the button

                if (username) {
                    userInfoBtn.textContent = username;  // Update the button text with the username
                    document.getElementById('login-container').style.display = 'none'; // Hide the login form
                    document.getElementById('form-container').style.display = 'block';  // Show the main form
                }
            } else {
                document.getElementById('login-container').style.display = 'block'; // Show login form if not logged in
                document.getElementById('form-container').style.display = 'none';   // Hide main form
            }

            resetTimer();  // Reset inactivity timer
        };

        // Toggle dropdown visibility when the user info button is clicked
        document.getElementById('user-info-btn').addEventListener('click', () => {
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown.style.display === 'none' || userDropdown.style.display === '') {
                userDropdown.style.display = 'block';  // Show the dropdown
            } else {
                userDropdown.style.display = 'none';  // Hide the dropdown
            }
        });

        // Logout function
        document.getElementById('logout-btn').addEventListener('click', () => {
            // Clear localStorage
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('username');

            // Hide the main form and show the login form
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';

            alert('kamu telah keluar.');

            // Optional: Reload the page to reset everything
            location.reload();
        });

        // Function to handle login
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Fetch credentials from the Google Apps Script
            fetch('https://script.google.com/macros/s/AKfycbyd-FvnNJMC7pTNOOEeWgHBJmP4MRMNLOwi_fOwwcg9877m7pSGxgkv_qTgYaMu8FsT/exec')
                .then(response => response.json())
                .then(credentials => {
                    // Check if the credentials match
                    const user = credentials.find(user => user.username === username && user.password === password);
                    if (user) {
                        // Set login status and store the new username in localStorage
                        localStorage.setItem('loggedIn', 'true');
                        localStorage.setItem('username', user.username); // Store the username

                        // Hide the login form and show the menu
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('menu-container').style.display = 'block';

                        // Update the user info button with the new username
                        document.getElementById('user-info-btn').textContent = user.username;
                    } else {
                        alert('akun salah, coba lagi.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('gagal masuk, masuk lagi nanti.');
                });
        }
        // Attach login event to the form
        document.getElementById('login-form').addEventListener('submit', login);

        // Handle the menu buttons for navigating
        document.getElementById('fill-form-btn').addEventListener('click', function() {
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('form-container').style.display = 'block';
        });

        // Fetch user-specific data from Google Sheets
        function fetchSheetData() {
            const sheetId = '1-Appfrc9S7RzJZO5aq4oxn73FtaOregvL3vOzpGJf6M';  // Your Google Sheet ID
            const apiKey = 'AIzaSyCMf51O_3RxFirEV1lzzwzGZtISqnrAfB0';    // Your API key
            const loggedInUser = localStorage.getItem('username'); // Get the logged-in user's username

            const sheetRange = `${loggedInUser}!A1:D`; // Use the username to access the corresponding tab

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetRange}?key=${apiKey}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data); // Log the entire response for debugging
                    if (data.values && data.values.length > 0) {
                        displayUserData(data.values); // Display the data for the user
                    } else {
                        alert('No data found for this user.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching sheet data:', error);
                    alert('Error fetching your data. Check the console for more details.');
                });
        }

        // Display the fetched data in a table format
        function displayUserData(data) {
            const sheetContainer = document.createElement('div');  // New container for Google Sheet data
            sheetContainer.id = 'sheet-container';  // Set an ID so we can hide it later

            let tableHtml = '<table border="1">';
            data.forEach(row => {
                tableHtml += '<tr>';
                row.forEach(cell => {
                    tableHtml += `<td>${cell}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</table>';

            // Create a Back button
            const backButton = document.createElement('button');
            backButton.innerText = 'Kembali';
            backButton.classList.add('back-btn');

            // Event listener for Back button
            backButton.addEventListener('click', function() {
                sheetContainer.style.display = 'none';  // Hide the sheet data container
                document.getElementById('menu-container').style.display = 'block';  // Show the menu
            });

            sheetContainer.innerHTML = tableHtml;
            sheetContainer.appendChild(backButton);

            // Hide the menu and form container when displaying the sheet data
            document.getElementById('menu-container').style.display = 'none';
            document.body.appendChild(sheetContainer);  // Add the new sheet data container to the body
        }

        // Event listeners for menu buttons
        document.getElementById('show-data-btn').addEventListener('click', function() {
            document.getElementById('menu-container').style.display = 'none';
            fetchSheetData(); // Call the correct function to fetch data
        });


        // Toggle Password Visibility
        document.getElementById('togglePassword').addEventListener('change', function() {
            const passwordInput = document.getElementById('password');
            passwordInput.type = this.checked ? 'text' : 'password';
        });

        let logoutTimer;
        const inactivityLimit = 10 * 60 * 1000; // Set inactivity limit to 10 minutes

        // Reset the inactivity timer
        function resetTimer() {
            clearTimeout(logoutTimer);  // Clear the previous timer
            logoutTimer = setTimeout(logout, inactivityLimit);  // Reset the timer
        }

        // Logout due to inactivity
        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('username');

            document.getElementById('form-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';

            alert('kamu keluar karena tidak aktif.');
        }

        // Start inactivity timer if logged in
        if (localStorage.getItem('loggedIn') === 'true') {
            resetTimer();  // Start the inactivity timer
        }

        // Listen for user activity
        window.addEventListener('mousemove', resetTimer);
        window.addEventListener('keypress', resetTimer);
        window.addEventListener('click', resetTimer);
        window.addEventListener('touchstart', resetTimer);  // For mobile users
        // Automatically log out if the user is already logged in but inactive
        if (localStorage.getItem('loggedIn') === 'true') {
            resetTimer();  // Start the inactivity timer
        }

        // Automatically show the form if the user is already logged in
        if (localStorage.getItem('loggedIn') === 'true') {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('form-container').style.display = 'block';
         }
        //biar balik nggulung
        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.getElementsByClassName("collapsible");
            for (let i = 0; i < collapsibles.length; i++) {
                collapsibles[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            }
        });
        
        function submitForm(event) {
            event.preventDefault(); // Prevent default form submission

            // Set the logged-in user's username in the hidden field
            document.getElementById('username-field').value = localStorage.getItem('username');

            const form = document.getElementById('form');
            const formData = new FormData(form);

            // Send the form data to the Google Apps Script URL
            fetch(form.action, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (response.ok) {
                    alert('Data berhasil terinput');
                    form.reset(); // Reset the form after successful submission

                    // Reset collapsible sections to their original state
                    const collapsibles = document.getElementsByClassName("collapsible");
                    for (let i = 0; i < collapsibles.length; i++) {
                        collapsibles[i].classList.remove("active");
                        const content = collapsibles[i].nextElementSibling;
                        content.style.maxHeight = null;
                    }
                } else {
                    alert('ada kesalahan dalam datamu. Tolong ulang lagi.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ada yang eror saat kamu masukkan data. tolong ulang lagi.');
            });
        }

        document.getElementById('back-to-menu-btn').addEventListener('click', function() {
            document.getElementById('menu-container').style.display = 'block'; 
            document.getElementById('form-container').style.display = 'none'; 
        });


        //for manifest
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
            });
        }
        </script>
          
</body>
</html>
