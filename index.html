<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optik Jaya </title>
    <base target="_top">
    <link rel="manifest" href="manifest.json">
    <script src="https://kit.fontawesome.com/7c51dff027.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }
        

        body {
            background: linear-gradient(135deg, #2E7445, #2E7445);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 10px;
            overflow: auto; /* Allow scrolling */
            touch-action: manipulation;  /* Enable gestures like pinch and pan */
        }

        .form-container {
            background-color: #ffffffb7;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 90vh;
            width: 100%;
            max-height: 80vh; /* Limit the height of the form */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        .view-data-container {
            max-width: 90vw; /* Set a different width for this specific container */
            background-color: #e0e0e0; /* Different background if needed */
        }

            h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            color: #333;
        }

        .logo {
            display: block;
            margin: 0 auto 20px; /* Center the logo and add margin below */
            max-width: 15vh; /* Ensure the logo is responsive */
            height: 15vh; /* Maintain aspect ratio */
        }

        .collapsible {
            background-color: #2E7445;
            color: white;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
        }

        .collapsible:hover {
            background-color: #194d2a;
        }

        .collapsible:after {
            content: '\002B'; /* Add plus symbol */
            color: white;
            float: right;
        }

        .collapsible.active:after {
            content: "\2212"; /* Add minus symbol when expanded */
        }

        .content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #f1f1f1;
            padding: 0 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin: 15px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 2px;
            border: 1px solid #ccc;
            font-size: 16px;
            color: #333;
            background-color: #f9f9f9;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #2E7445;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(116, 235, 213, 0.5);
        }

        textarea {
            resize: none;
        }

        input[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #2E7445;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        input[type="submit"]:hover {
            background-color: #194d2a;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        input[type="submit"]:active {
            transform: translateY(0);
        }

        .checkbox-group {
            margin-bottom: 15px;
        }

        .checkbox-group label {
            display: block;
            font-weight: normal;
        }

        .table-container {
            max-height: 400px;         /* Limit vertical height */
            overflow-y: auto;          /* Enable vertical scrolling */
            overflow-x: auto;          /* Enable horizontal scrolling */
            display: block;             /* Make sure the container is a block element */
            width: 100%;                /* Make the container take up the full width */
            box-sizing: border-box;     /* Include padding and border in width/height */
            white-space: nowrap;        /* Prevent the table from wrapping inside the container */
        }

        table {
            width: 100%;                /* Set table width to 100% for responsiveness */
            table-layout: auto;         /* Allow auto layout for better cell sizing */
            
        }

        th, td {
            white-space: nowrap;        /* Prevent text wrapping in cells */
            overflow: hidden;           /* Hide overflowed content */
            padding: 12px;              /* Increased padding for better readability */
            text-align: center;         /* Center-align text inside cells */
            font-size: 14px;            /* Adjust font size for readability */
        }

        th {
            background-color: #2E7445; /* Header background color */
            color: white;               /* Header text color */
            font-weight: bold;          /* Make header text bold */
        }

        td {
            background-color: #f9f9f9; /* Alternate background for cells */
            transition: background-color 0.3s; /* Transition for hover effects */
        }

        td:hover {
            background-color: #e1e1e1; /* Light grey background on hover */
        }

        

        /* Sticky Left Column */
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;                 /* Ensure the leftmost column stays on top */
        }

        @media only screen and (orientation: landscape) {
            .form-container {
                max-width: 80vw; /* Set the width based on viewport width */
                max-height: 90vh; /* Adjust the max height */
                background-color: #f0f0f0; /* Example of changing background color */
            }
        }


        /* Media Query for Mobile Responsiveness */
        @media (max-width: 768px) {
            .table-container {
                width: 90vw;            /* Ensure the container takes up the full width */
                overflow-x: auto;       /* Enable horizontal scrolling on smaller screens */
                padding: 0 10px;        /* Add padding for better readability */
            }
            

            table {
                width: max-content;     /* Allow table to take up the maximum content width */
                min-width: 100%;       /* Ensure a minimum width */
            }

            th, td {
                white-space: nowrap;    /* Prevent wrapping of text in small screens */
                font-size: 12px;        /* Smaller font size for better fitting */
            }
            

            td {
                text-align: left;
                position: relative;
            }

            td:before {
                content: attr(data-label); /* Add labels for mobile-friendly display */
                position: absolute;
                left: 10px;
                font-weight: bold;
            }

            td input[type="text"] {
                width: 100%;           /* Make input fields responsive */
                padding: 8px;
                box-sizing: border-box;
            }
        }
        
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;  /* Ensure the leftmost column stays on top */
        }

        .refraksi-table {
            width: 100%; /* Custom width for this table */
            background-color: #f9f9f9; /* Different background */
            text-align: left; /* Align text to the left */
            font-size: 15px; /* Font size adjustment */
        }

        .refraksi-table th, .refraksi-table td {
            padding: 10px; /* Adjust padding */
        }

        .refraksi-table th {
            background-color: #ffffff;
            color: #021005;
        }

        .refraksi-table td {
            background-color: #ffffff; /* Different cell background for data */
        }



        .menu-btn {
            width: 100%;
            padding: 12px;
            background-color: #2E7445;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .menu-btn:hover {
            background-color: #194d2a;
            transform: translateY(-2px);
        }

        .back-btn {
            position: absolute;  /* Allow for positioning relative to the nearest positioned ancestor */
            top: 10px;           /* Distance from the top of the container */
            left: 1px;          /* Distance from the left of the container */
            background-color:transparent; /* No background */
            color: #ffffff; /* Icon color */
            border: none; /* No border */
            display: flex;
            justify-content: center;   /* Center content horizontally */
            align-items: center;       /* Center content vertically */
            cursor: pointer; /* Pointer cursor on hover */
            width: 150px; /* Width of the button */
            height: 50px; /* Height of the button */
        }
        .back-btn i {
            margin-right: 10px;
        }

        .back-btn:hover {
            color: #aaa5a5; /* Change icon color on hover */
        }
            

        /* Style for Back to Search button */
        .back-btn-custom {
            background-color: #2e7445;  /* Dark red */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 20px;
            font-size: 16px;
            border: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .back-btn-custom:hover {
            background-color: #164425;  /* Lighter red on hover */
            transform: translateY(-2px);
        }

        /* Style for Reset Form button */
        .reset-btn-custom {
            background-color: #d3d3d3;  /* Light grey */
            color: black;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .reset-btn-custom:hover {
            background-color: #b0b0b0;  /* Slightly darker grey on hover */
            transform: translateY(-2px);
        }

        /* Flex container to align buttons side by side */
        .menu-container {
            display: flex;            /* Enable flexbox for the container */
            justify-content: center;  /* Center the buttons horizontally */
            gap: 20px;                /* Space between each button */
            flex-wrap: wrap;          /* Allow wrapping if the screen is too small */
        }

        /* Custom Menu Button Styling - Square Buttons */
        .menu-btn-square {
            background-color: #2E7445; /* Button background color */
            color: white;
            width: 150px;   /* Fixed width to make it square */
            height: 150px;  /* Fixed height to make it square */
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px; /* Text size */
            border: none;
            display: flex;
            flex-direction: column;  /* Stack icon and text vertically */
            align-items: center;     /* Center icon and text vertically */
            justify-content: center; /* Center icon and text horizontally */
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: center;
        }

        /* Style for the icons */
        .menu-btn-square i {
            font-size: 30px;   /* Adjust icon size */
            margin-bottom: 8px;  /* Space between icon and text */
        }

        .menu-btn-square:hover {
            background-color: #194d2a; /* Darker background on hover */
            transform: translateY(-2px); /* Slight raise effect on hover */
        }

        
    </style>
</head>
<body>
     <!-- Login Form -->
     <div id="login-container" class="form-container">
        <h2>Login to Optik Jaya </h2>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Nama Pengguna:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Kata sandi:</label>
                <input type="password" id="password" required>
                <input type="checkbox" id="togglePassword"> Lihat Sandi
            </div>
            
            <input type="submit" value="Login">
        </form>
    </div>
   
    <div id="menu-container" class="form-container" style="display: none;">
        <h2>Menu</h2>
        <!-- Container for Menu Buttons -->
        <div class="menu-container">
            <button id="fill-form-btn" class="menu-btn-square">
                <i class="fa-solid fa-file-pen"></i> Isi Formulir
            </button>
            <button id="show-data-btn" class="menu-btn-square">
                <i class="fas fa-eye"></i> Tampilkan Data
            </button>
            <button id="edit-data-btn" class="menu-btn-square">
                <i class="fas fa-edit"></i> Edit Data
            </button>
        </div>

    </div>
    
    <div id="data-view-container" class="form-container view-data-container" style="display: none;">
        <button id="back-to-data-btn" class="back-btn">
            <i class="fa-solid fa-circle-chevron-left fa-2x"></i>kembali
        </button> 
        <h2>Data Pasien Optik Jaya </h2>
        
        <input type="text" id="search-view-input" placeholder="Cari data..." oninput="searchDataInView()"  style="margin-bottom: 20px; padding: 10px; border-radius: 4px; border: 1px solid #ccc;">
        
        <div class="table-container" id="table-container">
            <!-- The table will be inserted here dynamically -->
        </div>
    </div>

    <div id="search-container" class="form-container" style="display: none;">
        <h2>Search Data to Edit</h2>
        <input type="text" id="search-edit-input" placeholder="Masukkan Nama atau lainnya" style="margin-bottom: 20px; padding: 10px; border-radius: 4px; border: 1px solid #ccc;">
        <button id="search-btn" class="menu-btn">Search</button>
        <button id="back-from-search-btn" class="back-btn">
            <i class="fa-solid fa-circle-chevron-left fa-2x"></i>kembali
        </button>
    </div>
    
    <div id="form-container" class="form-container" style="display: none;">
        <button id="back-to-menu-btn" class="back-btn">
            <i class="fa-solid fa-circle-chevron-left fa-2x"></i>kembali
        </button>
        <!-- User Info Section in the Top Right -->
        <div id="user-info-container" style="position: absolute; top: 20px; right: 20px;">
            <button id="user-info-btn" style="background-color: #ffffff; color: #2E7445; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer;">
                <!-- Username will be inserted here dynamically -->
            </button>
            <div id="user-dropdown" style="display: none; background-color: white; border: 1px solid #ccc; padding: 10px; position: absolute; top: 40px; right: 0px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);">
                <button id="logout-btn" style="background-color: #d9534f; color: white; border: none; border-radius: 8px; padding: 8px 15px; cursor: pointer;">Logout</button>
            </div>
        </div>
        
    
        <!-- Logo -->
        <img src=""https://i.imgur.com/ciEloG8.png" alt="Logo" class="logo">  <!-- Add your logo URL here -->
        <h2>Data Pasien Optik Jaya</h2>

        <form id="form" action="https://script.google.com/macros/s/AKfycbzmhTmEnCnH16Eju48QPrtfOl9yggFSZY1jRu5AJg-QlXdXLD4Ws3ibfBNPjG53txui/exec" method="POST" onsubmit="submitForm(event)">

            <!-- Collapsible Section 1 - Data Diri Pelanggan -->
            <button type="button" class="collapsible">Data Diri Pelanggan</button>
            <div class="content">
                <div class="form-group">
                    <label for="name">Nama:</label>
                    <input type="text" id="name" name="Nama" required>
                </div>

                <div class="form-group">
                    <label for="address">Alamat:</label>
                    <input type="text" id="address" name="Alamat" required>
                </div>

                <div class="form-group">
                    <label for="age">Umur:</label>
                    <input type="text" id="age" name="Umur" required>
                </div>

                <div class="form-group">
                    <label for="phone">HP:</label>
                    <input type="tel" id="phone" name="HP" pattern="[0-9]{11,12,13}" placeholder="081325465984" required>
                </div>

                <div class="field">
                    <label class="label">Status Pelanggan</label>
                    <div class="control">
                      <label class="radio">
                        <input type="radio" name="Status Pelanggan" value="Umum" /> Umum
                      </label>
                      <label class="radio">
                        <input type="radio" name="Status Pelanggan" value="BPJS" /> BPJS
                      </label>
                    </div>
                  </div>

                <div class="form-group">
                    <label for="coordinates">Koordinat Maps:</label>
                    <input type="text" id="coordinates" name="Koordinat" placeholder="e.g. -6.200000, 106.816666" >
                </div>
            </div>

            <!-- Collapsible Section 2 - Detail Pemesanan -->
            <button type="button" class="collapsible">Detail Pemesanan</button>
            <div class="content">
                <!-- Lensa field with multiple checkboxes -->
                <div class="form-group">
                    <label for="lensa">Lensa:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="lensa" value="Single - CRMC"> Single - WhiteMC</label>
                        <label><input type="checkbox" name="lensa" value="Single - CRMC"> Single - CRMC</label>
                        <label><input type="checkbox" name="lensa" value="Single - Photochromic"> Single - Photochromic</label>
                        <label><input type="checkbox" name="lensa" value="Single - Bluechromic"> Single - Bluechromic</label>
                        <label><input type="checkbox" name="lensa" value="Single - Night Drive"> Single - Night Drive</label>
                        <label><input type="checkbox" name="lensa" value="Single - Blu-ray"> Single - Blu-ray</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - CRMC"> Kriptok - WhiteMC</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - CRMC"> Kriptok - CRMC</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - Photochromic"> Kriptok - Photochromic</label>
                        <label><input type="checkbox" name="lensa" value="Kriptok - Bluechromic"> Kriptok - Bluechromic</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - CRMC"> Progressive - CRMC</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Photochromic"> Progressive - Photochromic</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Bluechromic"> Progressive - Bluechromic</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Night Drive"> Progressive - Night Drive</label>
                        <label><input type="checkbox" name="lensa" value="Progressive - Blu-ray"> Progressive - Blu-ray</label>
                    </div>
                </div>

                <!-- Frame field -->
                <div class="form-group">
                    <label for="frame">Frame:</label>
                    <input type="text" id="frame" name="frame" required>
                </div>

                <!-- Harga Awal -->
                <div class="form-group">
                    <label for="harga-awal">Harga Awal:</label>
                    <input type="number" id="harga-awal" name="harga awal" required>
                </div>

                <!-- Harga TT/Potongan -->
                <div class="form-group">
                    <label for="harga-tt">Harga TT/Potongan:</label>
                    <input type="number" id="harga-tt" name="harga tt" required>
                </div>

                <!-- Harga Akhir -->
                <div class="form-group">
                    <label for="harga-akhir">Harga Akhir:</label>
                    <input type="number" id="harga-akhir" name="harga akhir" required>
                </div>

                <div class="form-group">
                    <label>Stok Lensa:</label>
                    <div>
                       <label><input type="radio" name="stok-lensa" value="ada" required> Ada</label>
                       <label><input type="radio" name="stok-lensa" value="habis"> Habis</label>
                    </div>
                </div>
                
            </div>

            <!-- Collapsible Section 3 - Status Refraksi -->
            <button type="button" class="collapsible">Status Refraksi</button>
            <div class="content">
                <table class="refraksi-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>SPH</th>
                            <th>CYL</th>
                            <th>AXIS</th>
                        </tr>
                    </thead>
                    <tbody>
                         <tr>
                            <td>Kanan</td>
                            <td><input type="text" id="sph-kanan" name="sph kanan" placeholder="SPH Kanan"></td>
                            <td><input type="text" id="cyl-kanan" name="cyl kanan" placeholder="CYL Kanan"></td>
                            <td><input type="text" id="axis-kanan" name="axis kanan" placeholder="AXIS Kanan"></td>
                        </tr>
                        <tr>
                            <td>Kiri</td>
                            <td><input type="text" id="sph-kiri" name="sph kiri" placeholder="SPH Kiri"></td>
                            <td><input type="text" id="cyl-kiri" name="cyl kiri" placeholder="CYL Kiri"></td>
                            <td><input type="text" id="axis-kiri" name="axis kiri" placeholder="AXIS Kiri"></td>
                        </tr>
                        <tr>
                            <td>ADD</td>
                            <td><input type="text" id="sph-add" name="sph add" placeholder="SPH ADD"></td>
                            <td><input type="text" id="cyl-add" name="cyl add" placeholder="CYL ADD"></td>
                            <td><input type="text" id="axis-add" name="axis add" placeholder="AXIS ADD"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Collapsible Section 4 - Kirim & Tagih -->
            <button type="button" class="collapsible">Kirim & Tagih</button>
            <div class="content">
                <!-- DP field -->
                <div class="form-group">
                    <label for="dp">DP (IDR):</label>
                    <input type="number" id="dp" name="DP" required placeholder="Masukkan DP" step="any">
                </div>

                <!-- Tanggal Penagihan and Bayar fields -->
                <div class="form-group">
                    <label for="Pengiriman">Pengiriman:</label>
                    <input type="date" id="pengiriman" name="Pengiriman" required>

                    <label for="tanggal-1">Bayar 1:</label> <!-- Date Field -->
                    <input type="date" id="tanggal-1" name="tanggal-bayar-1" required>

                    <label for="bayar-1">Bayar 1 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-1" name="bayar-1" required placeholder="Masukkan Bayar 1 (IDR)" step="any" min="0">

                    <label for="tanggal-2">Bayar 2:</label> <!-- Date Field -->
                    
                    <input type="date" id="tanggal-2" name="tanggal-bayar-2">

                    <label for="bayar-2">Bayar 2 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-2" name="bayar-2" placeholder="Masukkan Bayar 2 (IDR)" step="any" min="0">

                    <label for="tanggal-3">Bayar 3:</label> <!-- Date Field -->
                    <input type="date" id="tanggal-3" name="tanggal-bayar-3">

                    <label for="bayar-3">Bayar 3 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-3" name="bayar-3" placeholder="Masukkan Bayar 3 (IDR)" step="any" min="0">

                    <label for="tanggal-4">Bayar 4:</label> <!-- Date Field -->
                    <input type="date" id="tanggal-4" name="tanggal-bayar-4">

                    <label for="bayar-4">Bayar 4 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-4" name="bayar-4" placeholder="Masukkan Bayar 4 (IDR)" step="any" min="0">

                    <label for="tanggal-5">Bayar 5:</label> <!-- Date Field -->
                    <input type="date" id="tanggal-5" name="tanggal-bayar-5">

                    <label for="bayar-5">Bayar 5 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-5" name="bayar-5" placeholder="Masukkan Bayar 5 (IDR)" step="any" min="0">

                    <label for="tanggal-6">Bayar 6:</label> <!-- Date Field -->
                    <input type="date" id="tanggal-6" name="tanggal-bayar-6">

                    <label for="bayar-6">Bayar 6 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-6" name="bayar-6" placeholder="Masukkan Bayar 6 (IDR)" step="any" min="0">

                    <label for="tanggal-7">Bayar 7:</label> <!-- Date Field -->
                    <input type="date" id="tanggal-7" name="tanggal-bayar-7">

                    <label for="bayar-7">Bayar 7 (IDR):</label> <!-- Currency Field -->
                    <input type="number" id="bayar-7" name="bayar-7" placeholder="Masukkan Bayar 7 (IDR)" step="any" min="0">
                </div>
            </div>
            
            <!-- Add the hidden input field here to store the username -->
            <input type="hidden" id="username-field" name="username" value="">

            <!-- Submit Button -->
            <input type="submit" value="Kirim Data" id="submit-button">
            <button id="back-to-search-btn" class="back-btn-custom">cari</button>
            <button type="reset" id="reset-form-btn" class="reset-btn-custom">Reset Form</button>
        </form>
    </div>

    <script>
            
         // Get references to the user info elements
        const userInfoBtn = document.getElementById('user-info-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const logoutBtn = document.getElementById('logout-btn');

       // Function to run when the window loads
        window.onload = function () {
            // Check if the user is logged in
            if (localStorage.getItem('loggedIn') === 'true') {
                const username = localStorage.getItem('username'); // Retrieve the username
                const userInfoBtn = document.getElementById('user-info-btn'); // Reference the button

                if (username) {
                    const menuHeader = document.querySelector('#menu-container h2');
                    menuHeader.textContent = 'Hai, ' + username + '!';
                    userInfoBtn.textContent = username;  // Update the button text with the username
                    document.getElementById('login-container').style.display = 'none'; // Hide the login form
                    document.getElementById('form-container').style.display = 'block';  // Show the main form
                }
            } else {
                document.getElementById('login-container').style.display = 'block'; // Show login form if not logged in
                document.getElementById('form-container').style.display = 'none';   // Hide main form
            }

            resetTimer();  // Reset inactivity timer
        };

        // Toggle dropdown visibility when the user info button is clicked
        document.getElementById('user-info-btn').addEventListener('click', () => {
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown.style.display === 'none' || userDropdown.style.display === '') {
                userDropdown.style.display = 'block';  // Show the dropdown
            } else {
                userDropdown.style.display = 'none';  // Hide the dropdown
            }
        });

        // Logout function
        document.getElementById('logout-btn').addEventListener('click', () => {
            // Clear localStorage
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('username');

            // Hide the main form and show the login form
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';

            alert('kamu telah keluar.');

            // Optional: Reload the page to reset everything
            location.reload();
        });

        // Function to handle login
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // untuk ngambil username dan pw
            fetch('https://script.google.com/macros/s/AKfycbyd-FvnNJMC7pTNOOEeWgHBJmP4MRMNLOwi_fOwwcg9877m7pSGxgkv_qTgYaMu8FsT/exec')
                .then(response => response.json())
                .then(credentials => {
                    // Check if the credentials match
                    const user = credentials.find(user => user.username === username && user.password === password);
                    if (user) {
                        // Set login status and store the new username in localStorage
                        localStorage.setItem('loggedIn', 'true');
                        localStorage.setItem('username', user.username); // Store the username

                        // Hide the login form and show the menu
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('menu-container').style.display = 'block';

                        // Update the user info button with the new username
                        document.getElementById('user-info-btn').textContent = user.username;
                    } else {
                        alert('akun salah, coba lagi.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('gagal masuk, masuk lagi nanti.');
                });
        }
        // Attach login event to the form
        document.getElementById('login-form').addEventListener('submit', login);

        // Handle the menu buttons for navigating
        document.getElementById('fill-form-btn').addEventListener('click', function() {
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('form-container').style.display = 'block';
        });

        // Event listener for the show data button
        document.getElementById('show-data-btn').addEventListener('click', function() {
            document.getElementById('menu-container').style.display = 'none'; // Hide the menu
            fetchSheetData(); // Call the function to fetch data and display it
        });

        

        // Fetch user-specific data from Google Sheets
        function fetchSheetData() {
            const sheetId = '1-Appfrc9S7RzJZO5aq4oxn73FtaOregvL3vOzpGJf6M'; // Your Google Sheet ID
            const apiKey = 'AIzaSyCMf51O_3RxFirEV1lzzwzGZtISqnrAfB0'; // Your API key
            const loggedInUser = localStorage.getItem('username'); // Get the logged-in user's username

            const sheetRanges = [`${loggedInUser}!A1:AK`]; // Ensure the username is the correct sheet name
            const rangesQuery = sheetRanges.map(range => `ranges=${encodeURIComponent(range)}`).join('&');

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values:batchGet?${rangesQuery}&key=${apiKey}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.valueRanges && data.valueRanges[0].values && data.valueRanges[0].values.length > 0) {
                        displayUserData(data.valueRanges[0].values); // Call the function to display data
                        document.getElementById('data-view-container').style.display = 'block'; // Show the data view container
                    } else {
                        alert('No data found for this user.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching sheet data:', error);
                    alert('Error fetching your data. Check the console for more details.');
                });
        }

        // Function to display user data
        function displayUserData(data) {
            const tableContainer = document.getElementById('table-container');
            tableContainer.innerHTML = ''; // Clear previous content

            // Create the table
            let tableHtml = '<table border="1"><thead><tr>';
            const headers = data[0]; // First row should contain headers
            headers.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            // Create table rows for the remaining data
            data.slice(1).forEach(row => {
                tableHtml += '<tr>';
                row.forEach(cell => {
                    tableHtml += `<td>${cell || ''}</td>`; // Handle empty cells gracefully
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml; // Insert the table into the container
        }


        // Search function
        function searchDataInView() {
            const input = document.getElementById('search-view-input').value.toLowerCase();
            const table = document.querySelector('#table-container table');
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowText = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' '); // Join cell text
                if (rowText.includes(input)) {
                    row.style.display = ''; // Show row
                } else {
                    row.style.display = 'none'; // Hide row
                }
            });
        }

        // Back button for data view
        document.getElementById('back-to-data-btn').addEventListener('click', function() {
            document.getElementById('data-view-container').style.display = 'none'; 
            document.getElementById('menu-container').style.display = 'block'; 
        });

         // Event listener for the Edit Data button
         document.getElementById('edit-data-btn').addEventListener('click', function () {
            document.getElementById('menu-container').style.display = 'none'; // Hide the menu
            document.getElementById('search-container').style.display = 'block'; // Show the search field
        });

        // Function to fetch data and allow editing
        function fetchAndEditData() {
            const sheetId = '1-Appfrc9S7RzJZO5aq4oxn73FtaOregvL3vOzpGJf6M';
            const apiKey = 'AIzaSyCMf51O_3RxFirEV1lzzwzGZtISqnrAfB0';
            const loggedInUser = localStorage.getItem('username');

            // Fetch the user's data
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${loggedInUser}!A1:AK?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Pre-fill the form with existing data
                    if (data.values && data.values.length > 1) {
                        populateForm(data.values[1]); // Assuming the second row contains user data
                        document.getElementById('form-container').style.display = 'block';
                    } else {
                        alert('No data found for this user.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('Failed to load data.');
                });
        }

       // Function to populate the form with fetched data and make prefilled fields read-only
        function populateForm(userData) {
            // Helper function to set value and readonly attribute if the field exists
            function setFieldValue(id, value) {
                const field = document.getElementById(id);
                if (field) { // Check if the field exists
                    field.value = value;
                    if (value !== '') {
                        field.setAttribute('readonly', true); // Make prefilled fields read-only
                    } else {
                        field.removeAttribute('readonly'); // Allow editing blank fields
                    }
                } else {
                    console.error(`Element with id "${id}" not found.`);
                }
            }

            // Data Diri Pelanggan
            setFieldValue('name', userData[0]); // "Nama"
            setFieldValue('address', userData[1]); // "Alamat"
            setFieldValue('age', userData[2]); // "Umur"
            setFieldValue('phone', userData[3]); // "HP"

            // Status Pelanggan (Radio buttons - read-only handled separately)
            const statusPelangganField = document.querySelector(`input[name="Status Pelanggan"][value="${userData[4]}"]`);
            if (statusPelangganField) {
                statusPelangganField.checked = true;
                document.querySelectorAll('input[name="Status Pelanggan"]').forEach(input => input.disabled = true); // Disable the radio buttons
            }

            // Koordinat
            setFieldValue('coordinates', userData[5]); // "Koordinat"

            // Detail Pemesanan (Lensa)
            const selectedLensa = userData[6].split(', ');
            document.querySelectorAll('input[name="lensa"]').forEach(checkbox => {
                checkbox.checked = selectedLensa.includes(checkbox.value);
                checkbox.disabled = selectedLensa.includes(checkbox.value); // Disable prefilled checkboxes
            });

            setFieldValue('frame', userData[7]); // "Frame"
            setFieldValue('harga-awal', userData[8]); // "Harga Awal"
            setFieldValue('harga-tt', userData[9]); // "Harga TT"
            setFieldValue('harga-akhir', userData[10]); // "Harga Akhir"

            // Status Refraksi
            setFieldValue('sph-kanan', userData[11]); // "SPH Kanan"
            setFieldValue('cyl-kanan', userData[12]); // "CYL Kanan"
            setFieldValue('axis-kanan', userData[13]); // "Axis Kanan"

            setFieldValue('sph-kiri', userData[14]); // "SPH Kiri"
            setFieldValue('cyl-kiri', userData[15]); // "CYL Kiri"
            setFieldValue('axis-kiri', userData[16]); // "Axis Kiri"

            setFieldValue('sph-add', userData[17]); // "SPH Add"
            setFieldValue('cyl-add', userData[18]); // "CYL Add"
            setFieldValue('axis-add', userData[19]); // "Axis Add"

            // Kirim & Tagih
            setFieldValue('dp', userData[20]); // "DP"

           // Add Pengiriman (this was missing)
            setFieldValue('pengiriman', userData[21]); // Pengiriman

            // Kirim & Tagih
            setFieldValue('tanggal-1', userData[22]); // Bayar 1 Date
            setFieldValue('bayar-1', userData[23]); // Bayar 1 (IDR)

            setFieldValue('tanggal-2', userData[24]); // Bayar 2 Date
            setFieldValue('bayar-2', userData[25]); // Bayar 2 (IDR)

            setFieldValue('tanggal-3', userData[26]); // Bayar 3 Date
            setFieldValue('bayar-3', userData[27]); // Bayar 3 (IDR)

            setFieldValue('tanggal-4', userData[28]); // Bayar 4 Date
            setFieldValue('bayar-4', userData[29]); // Bayar 4 (IDR)

            setFieldValue('tanggal-5', userData[30]); // Bayar 5 Date
            setFieldValue('bayar-5', userData[31]); // Bayar 5 (IDR)

            setFieldValue('tanggal-6', userData[32]); // Bayar 6 Date
            setFieldValue('bayar-6', userData[33]); // Bayar 6 (IDR)

            setFieldValue('tanggal-7', userData[34]); // Bayar 7 Date
            setFieldValue('bayar-7', userData[35]); // Bayar 7 (IDR)

            // Add Stok Lensa (was missing)
            const stoklensaField = document.querySelector(`input[name="stok-lensa"][value="${userData[36]}"]`);
            if (stoklensaField) {
               stoklensaField.checked = true;
                document.querySelectorAll('input[name="stok-lensa"]').forEach(input => input.disabled = true); // Disable the radio buttons
            }

        }

        // Event listener for the search button in Edit Data
        document.getElementById('search-btn').addEventListener('click', function() {
            const query = document.getElementById('search-edit-input').value.trim(); // Use the updated input ID
            if (query) {
                searchDataToEdit(query); // Call the updated search function for Edit Data
            } else {
                alert('Please enter a search term.'); // Show alert if the input is empty
            }
        });

        // Back button functionality for Search Data page
        document.getElementById('back-from-search-btn').addEventListener('click', function() {
            document.getElementById('search-container').style.display = 'none';  // Hide the search container
            document.getElementById('menu-container').style.display = 'block';  // Show the menu container
        });

        document.getElementById('form-container').style.display = 'block'; // Show the form


        function searchDataToEdit(query) {
            const sheetId = '1QZWhL4y-YLY47UKQwFm6OPiwhcS0ihY8HRG54HVDDh0'; // Your Google Sheet ID
            const apiKey = 'AIzaSyDmXIJyYyiabogk7obXeB3XT852myYt5jg'; // Your API key
            const loggedInUser = localStorage.getItem('username'); // Get the logged-in user's username

            const sheetRanges = [`${loggedInUser}!A1:AK`]; // Ensure the username is the correct sheet name
            const rangesQuery = sheetRanges.map(range => `ranges=${encodeURIComponent(range)}`).join('&');

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${loggedInUser}!A1:AK?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(data.values);
                    if (data.values && data.values.length > 1) {
                        // Convert query to lowercase for case-insensitive search
                        const lowerQuery = query.toLowerCase();

                        // Find matching row (assuming query could be found in any cell of the row)
                        const matchingRow = data.values.find(row => 
                            row.some(cell => cell.toLowerCase().includes(lowerQuery))
                        );
                        
                        if (matchingRow) {
                            populateForm(matchingRow); // Populate the form with the matching data
                            document.getElementById('search-container').style.display = 'none'; // Hide the search container
                            document.getElementById('form-container').style.display = 'block'; // Show the form
                        } else {
                            alert('No matching data found.');
                        }
                    } else {
                        alert('No data found.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('Failed to load data. Try again later.');
                });
        }


        document.getElementById('back-to-search-btn').addEventListener('click', function() {
            document.getElementById('form-container').style.display = 'none'; // Hide the form
            document.getElementById('search-container').style.display = 'block'; // Show the search input
            document.getElementById('form').reset(); // Optionally reset the form
        });

        // Modify the existing submitForm function to update data instead of inserting new data
        function submitForm(event) {
            event.preventDefault();

            // Prepare the updated data to send
            const form = document.getElementById('form');
            const formData = new FormData(form);

            // Send updated data back to Google Sheets
            fetch(form.action, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.ok ? alert('Data updated successfully!') : alert('Error updating data'))
            .catch(error => console.error('Error:', error));
        }

        // Toggle Password Visibility
        document.getElementById('togglePassword').addEventListener('change', function() {
            const passwordInput = document.getElementById('password');
            passwordInput.type = this.checked ? 'text' : 'password';
        });

        let logoutTimer;
        const inactivityLimit = 10 * 60 * 1000; // Set inactivity limit to 10 minutes

        // Reset the inactivity timer
        function resetTimer() {
            clearTimeout(logoutTimer);  // Clear the previous timer
            logoutTimer = setTimeout(logout, inactivityLimit);  // Reset the timer
        }

        // Logout due to inactivity
        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('username');

            document.getElementById('form-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';

            alert('kamu keluar karena tidak aktif.');
        }

        // Start inactivity timer if logged in
        if (localStorage.getItem('loggedIn') === 'true') {
            resetTimer();  // Start the inactivity timer
        }

        // Listen for user activity
        window.addEventListener('mousemove', resetTimer);
        window.addEventListener('keypress', resetTimer);
        window.addEventListener('click', resetTimer);
        window.addEventListener('touchstart', resetTimer);  // For mobile users
        // Automatically log out if the user is already logged in but inactive
        if (localStorage.getItem('loggedIn') === 'true') {
            resetTimer();  // Start the inactivity timer
        }

        // Automatically show the form if the user is already logged in
        if (localStorage.getItem('loggedIn') === 'true') {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('form-container').style.display = 'block';
         }
        //biar balik nggulung
        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.getElementsByClassName("collapsible");
            for (let i = 0; i < collapsibles.length; i++) {
                collapsibles[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            }
        });
        
        function submitForm(event) {
            event.preventDefault(); // Prevent default form submission

            // Set the logged-in user's username in the hidden field
            document.getElementById('username-field').value = localStorage.getItem('username');

            const form = document.getElementById('form');
            const formData = new FormData(form);

            // Send the form data to the Google Apps Script URL
            fetch(form.action, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (response.ok) {
                    alert('Data berhasil terinput');
                    form.reset(); // Reset the form after successful submission

                    // Reset collapsible sections to their original state
                    const collapsibles = document.getElementsByClassName("collapsible");
                    for (let i = 0; i < collapsibles.length; i++) {
                        collapsibles[i].classList.remove("active");
                        const content = collapsibles[i].nextElementSibling;
                        content.style.maxHeight = null;
                    }
                } else {
                    alert('ada kesalahan dalam datamu. Tolong ulang lagi.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ada yang eror saat kamu masukkan data. tolong ulang lagi.');
            });
        }

        document.getElementById('back-to-menu-btn').addEventListener('click', function() {
            document.getElementById('menu-container').style.display = 'block'; 
            document.getElementById('form-container').style.display = 'none'; 
        });


            const tableContainer = document.querySelector('.table-container');
            let scale = 1;  // Initial zoom scale

            // Handle zoom event
            function zoom(event) {
                event.preventDefault();
                if (event.ctrlKey) {  // Zoom when Ctrl is held (for desktop)
                    scale += event.deltaY * -0.01;  // Adjust zoom scale
                    scale = Math.min(Math.max(0.5, scale), 3);  // Limit zoom level between 50% and 300%
                    
                    tableContainer.style.transform = `scale(${scale})`;  // Apply zoom scale
                    tableContainer.style.transformOrigin = '0 0';  // Keep origin at top-left
                    tableContainer.scrollLeft = 0;  // Reset horizontal scroll to 0 after zoom
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
            const tableContainer = document.querySelector('.table-container');
            const table = tableContainer.querySelector('table');

            // Check if table exists before trying to access its properties
            if (table) {
                // Adjust table width based on container width
                if (table.offsetWidth > window.innerWidth) {
                    tableContainer.style.overflowX = 'auto'; // Enable horizontal scroll if overflow
                } else {
                    tableContainer.style.overflowX = 'hidden'; // Hide scroll if no overflow
                }
            } else {
                console.error('Table not found in the container.'); // Log error if table is null
            }
        });

        // Also, make sure to attach the resize event to adjust on window size change
        window.addEventListener('resize', function() {
            const tableContainer = document.querySelector('.table-container');
            const table = tableContainer.querySelector('table');

            if (table) {
                // Adjust table width based on container width
                if (table.offsetWidth > window.innerWidth) {
                    tableContainer.style.overflowX = 'auto'; // Enable horizontal scroll if overflow
                } else {
                    tableContainer.style.overflowX = 'hidden'; // Hide scroll if no overflow
                }
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then((registration) => {
                console.log('ServiceWorker registered: ', registration);
                })
                .catch((registrationError) => {
                console.log('ServiceWorker registration failed: ', registrationError);
                });
            });
        }

        function resetReadOnlyFields() {
            // Find all input fields within the form
            const fields = document.querySelectorAll('#form input');

            // Iterate over each field and remove 'readonly' attribute
            fields.forEach(field => {
                field.removeAttribute('readonly'); // Remove 'readonly'
                field.disabled = false; // Re-enable any disabled fields (e.g. radio buttons)
            });

            // Reset checkboxes (for fields like 'lensa')
            const checkboxes = document.querySelectorAll('#form input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = false; // Re-enable checkboxes
            });

            // Reset radio buttons (for 'Status Pelanggan')
            const radioButtons = document.querySelectorAll('input[name="Status Pelanggan"]');
            radioButtons.forEach(radio => {
                radio.disabled = false; // Re-enable radio buttons
            });
        }
        document.getElementById('reset-form-btn').addEventListener('click', function() {
            // Reset the form (this will clear all fields)
            document.getElementById('form').reset();

            // Remove read-only attributes
            resetReadOnlyFields(); // Call the function to remove 'readonly' attributes
        });

        </script>
          
</body>
</html>
